name: Deploy to Ubuntu Server

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
  push:
    tags:
      - 'deploy-*'

env:
  GO_VERSION: '1.23'
  NODE_VERSION: '20'
  BINARY_NAME: 'ocpp-emu'
  CONFIG_PATH: '/etc/conf/ocpp-emu.yml'
  WEB_PATH: '/var/www/html/ocpp-emu'
  SERVICE_NAME: 'ocpp-emu'

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi

      # Build Backend
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build backend
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          go build -ldflags="-s -w -X main.appVersion=${{ steps.version.outputs.version }}" \
            -o ${{ env.BINARY_NAME }} \
            ./cmd/server

      # Build Frontend
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Build frontend
        working-directory: web
        run: |
          npm ci
          npm run build

      # Prepare deployment package
      - name: Prepare deployment package
        run: |
          mkdir -p deploy/web
          cp ${{ env.BINARY_NAME }} deploy/
          cp -r web/dist/* deploy/web/
          cp configs/config.yaml deploy/
          cp scripts/ocpp-emu.service deploy/

      # Copy files to server
      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy/*"
          target: "/tmp/ocpp-emu-deploy"
          strip_components: 1

      # Deploy on server
      - name: Deploy on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: BINARY_NAME,CONFIG_PATH,WEB_PATH,SERVICE_NAME
          script: |
            set -e

            echo "=== Starting deployment ==="
            cd /tmp/ocpp-emu-deploy

            # Stop service if running
            if systemctl is-active --quiet $SERVICE_NAME 2>/dev/null; then
              echo "Stopping existing service..."
              sudo systemctl stop $SERVICE_NAME
            fi

            # Install binary
            echo "Installing binary..."
            sudo cp $BINARY_NAME /usr/local/bin/
            sudo chmod 755 /usr/local/bin/$BINARY_NAME
            sudo chown root:root /usr/local/bin/$BINARY_NAME

            # Create service user if not exists
            if ! id ocpp-emu &>/dev/null; then
              echo "Creating service user..."
              sudo useradd --system --no-create-home --shell /bin/false ocpp-emu
            fi

            # Create directories
            echo "Creating directories..."
            sudo mkdir -p /etc/conf
            sudo mkdir -p $WEB_PATH
            sudo mkdir -p /var/log/ocpp-emu
            sudo chown ocpp-emu:ocpp-emu /var/log/ocpp-emu

            # Install config (only if not exists)
            if [ ! -f "$CONFIG_PATH" ]; then
              echo "Installing config..."
              sudo cp config.yaml $CONFIG_PATH
              sudo chmod 640 $CONFIG_PATH
              sudo chown root:ocpp-emu $CONFIG_PATH
            else
              echo "Config exists, preserving existing configuration"
            fi

            # Install web files
            echo "Installing web files..."
            sudo rm -rf $WEB_PATH/*
            sudo cp -r web/* $WEB_PATH/
            sudo chown -R www-data:www-data $WEB_PATH
            sudo chmod -R 755 $WEB_PATH

            # Install systemd service
            echo "Installing systemd service..."
            sudo cp ocpp-emu.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl enable $SERVICE_NAME

            # Start service
            echo "Starting service..."
            sudo systemctl start $SERVICE_NAME

            # Cleanup
            cd /tmp
            rm -rf /tmp/ocpp-emu-deploy

            echo "=== Deployment complete ==="

      # Verify deployment
      - name: Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: SERVICE_NAME,WEB_PATH
          script: |
            echo "=== Service Status ==="
            sudo systemctl status $SERVICE_NAME --no-pager || true

            echo ""
            echo "=== API Health Check ==="
            sleep 2
            curl -s http://localhost:8080/api/health || echo "API not responding"

            echo ""
            echo "=== Web Files ==="
            ls -la $WEB_PATH/ | head -10

      - name: Deployment summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Binary:** /usr/local/bin/${{ env.BINARY_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Config:** ${{ env.CONFIG_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Web App:** ${{ env.WEB_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service:** systemctl status ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
